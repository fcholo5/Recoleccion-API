name: üöÄ Deploy Laravel Backend

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # ----------------- CHECKOUT -----------------
      - name: üîç Checkout c√≥digo
        uses: actions/checkout@v4

      # ----------------- PHP -----------------
      - name: üêò Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, xml, ctype, json, tokenizer, fileinfo, curl, pgsql, pdo, pdo_pgsql
          tools: composer:v2

      # ----------------- DEPENDENCIAS -----------------
      - name: üì¶ Instalar dependencias de Composer (producci√≥n)
        run: |
          composer install --no-dev --no-progress --no-suggest --prefer-dist --optimize-autoloader

      # ----------------- LIMPIAR CARPETA EN SERVIDOR -----------------
      - name: üßπ Limpiar contenido anterior (excepto .env)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            # Eliminar todo excepto .env (si existe)
            find /home/fabian_panameno/api -mindepth 1 -maxdepth 1 ! -name '.env' -exec rm -rf {} + 2>/dev/null || true
            echo "‚úî Carpeta de backend limpiada (se preserv√≥ .env si exist√≠a)"

      # ----------------- SUBIR ARCHIVOS -----------------
      - name: üì§ Subir c√≥digo al servidor (rsync)
        uses: appleboy/rsync-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "api/"
          target: "/var/www/fabian_site/"
          # Usamos args para pasar exclusiones y opciones de rsync
          args: "-avz --delete --exclude='.git/' --exclude='.github/' --exclude='tests/' --exclude='storage/' --exclude='vendor/' --exclude='.env' --exclude='.env.example' --exclude='README.md'"

      # ----------------- CONFIGURAR Y MIGRAR EN SERVIDOR -----------------
      - name: ‚öôÔ∏è Configurar permisos y ejecutar migraciones
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /home/fabian_panameno/api

            # Asegurar permisos de escritura
            chmod -R 775 storage bootstrap/cache
            chown -R fabian_panameno:fabian_panameno storage bootstrap/cache

            # Limpiar cach√© antigua
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear

            # Aplicar migraciones (¬°en el servidor, con PostgreSQL!)
            php artisan migrate --force

            # Optimizar para producci√≥n
            php artisan config:cache
            php artisan route:cache

            echo "‚úÖ Backend Laravel desplegado correctamente"
            