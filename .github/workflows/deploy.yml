name: üöÄ Deploy Laravel Backend

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üêò Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, xml, ctype, json, tokenizer, fileinfo, curl, pgsql, pdo, pdo_pgsql
          tools: composer:v2

      - name: üì¶ Install Composer dependencies (sin dev)
        run: composer install --no-dev --no-progress --no-suggest --prefer-dist --optimize-autoloader

      - name: üßπ Remove unnecessary files
        run: |
          rm -rf .git .github tests
          # Opcional: compilar assets si los tienes (pero en backend puro Laravel no suele haber)

      - name: üì§ Upload code to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: "."
          target: "/var/www/tu_proyecto_backend/"
          recursive: true
          overwrite: true
          strip_components: 1

      - name: ‚öôÔ∏è Run server-side setup
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            cd /var/www/tu_proyecto_backend

            # Asegurar permisos
            chmod -R 775 storage bootstrap/cache
            chown -R www-data:www-data storage bootstrap/cache

            # Optimizar (opcional pero recomendado en producci√≥n)
            php artisan config:cache
            php artisan route:cache
            php artisan event:cache

            # Ejecutar migraciones (con --force porque es producci√≥n)
            php artisan migrate --force

            echo "‚úÖ Backend Laravel desplegado y migrado correctamente"